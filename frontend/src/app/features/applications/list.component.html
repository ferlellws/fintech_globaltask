<div class="dashboard-layout animate-fade">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <div class="logo-icon"><ion-icon name="card-outline"></ion-icon></div>
            <h2>GlobalTask</h2>
        </div>
        <nav class="nav-links">
            <a routerLink="/applications" class="active"><ion-icon name="list-outline" class="icon"></ion-icon>
                Solicitudes</a>
        </nav>
        <div class="user-profile">
            <div class="avatar">{{ auth.currentUser()?.email?.charAt(0)?.toUpperCase() }}</div>
            <div class="user-info">
                <span class="email">{{ auth.currentUser()?.email }}</span>
            </div>
            <button class="logout-btn" (click)="logout()" title="Cerrar sesión">
                <ion-icon name="log-out-outline"></ion-icon>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="top-bar">
            <div>
                <h1>Solicitudes de Crédito <span class="badge-live">LIVE</span></h1>
                <p class="subtitle"><span class="dot pulse"></span> Motor de Riesgo en Tiempo Real</p>
            </div>
            <button class="btn-primary" routerLink="/applications/new">
                <ion-icon name="add-outline"></ion-icon> Nueva Solicitud
            </button>
        </header>

        <!-- Filtros -->
        <div class="filters-bar">
            <div class="filter-group">
                <label for="countryFilter">País:</label>
                <select id="countryFilter" [(ngModel)]="filterCountry" (change)="onFilterChange()">
                    <option value="">Todos los países</option>
                    @for (c of countries(); track c.code) {
                    <option [value]="c.code">{{ c.name }}</option>
                    }
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Estado:</label>
                <select id="statusFilter" [(ngModel)]="filterStatus" (change)="onFilterChange()">
                    <option value="">Todos los estados</option>
                    @for (s of statuses(); track s.code) {
                    <option [value]="s.code">{{ s.name }}</option>
                    }
                </select>
            </div>
        </div>

        <!-- Cards Section (Stats) -->
        <div class="stats-grid">
            <div class="stat-card card-total">
                <div class="stat-header">
                    <div class="stat-icon-box"><ion-icon name="pie-chart"></ion-icon></div>
                    <span class="stat-trend trend-neutral">Global</span>
                </div>
                <div class="stat-content">
                    <h3>Total Solicitudes</h3>
                    <p class="stat-value">{{ totalCount }}</p>
                </div>
            </div>

            <div class="stat-card card-pending">
                <div class="stat-header">
                    <div class="stat-icon-box"><ion-icon name="time"></ion-icon></div>
                    <span class="stat-trend trend-up"><ion-icon name="trending-up-outline"></ion-icon> +12%</span>
                </div>
                <div class="stat-content">
                    <h3>En Espera</h3>
                    <p class="stat-value">{{ pendingCount }}</p>
                </div>
            </div>

            <div class="stat-card card-review">
                <div class="stat-header">
                    <div class="stat-icon-box"><ion-icon name="hammer"></ion-icon></div>
                    <span class="stat-trend trend-neutral">Prioritario</span>
                </div>
                <div class="stat-content">
                    <h3>Revisión Manual</h3>
                    <p class="stat-value">{{ manualReviewCount }}</p>
                </div>
            </div>

            <div class="stat-card card-success">
                <div class="stat-header">
                    <div class="stat-icon-box"><ion-icon name="checkmark-circle"></ion-icon></div>
                    <span class="stat-trend trend-up">+8.5%</span>
                </div>
                <div class="stat-content">
                    <h3>Aprobadas</h3>
                    <p class="stat-value">{{ approvedCount }}</p>
                </div>
            </div>

            <div class="stat-card card-danger">
                <div class="stat-header">
                    <div class="stat-icon-box"><ion-icon name="close-circle"></ion-icon></div>
                    <span class="stat-trend trend-down">-2.1%</span>
                </div>
                <div class="stat-content">
                    <h3>Rechazadas</h3>
                    <p class="stat-value">{{ rejectedCount }}</p>
                </div>
            </div>

            <div class="stat-card card-money">
                <div class="stat-header">
                    <div class="stat-icon-box"><ion-icon name="cash"></ion-icon></div>
                    <ion-icon name="ellipsis-horizontal-outline" style="color: #64748b"></ion-icon>
                </div>
                <div class="stat-content">
                    <h3>Capital Solicitado</h3>
                    <p class="stat-value">{{ formatCurrency(totalAmountAmount) }}</p>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            @if (loading()) {
            <div class="empty-state-container">
                <div class="spinner-small" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;"></div>
                <p>Cargando información...</p>
            </div>
            } @else if (applications().length === 0) {
            <div class="empty-state-container empty-state-beautiful">
                <div class="empty-icon-wrapper">
                    <ion-icon name="document-text-outline"></ion-icon>
                </div>
                <h3>No hay solicitudes aún</h3>
                <p>Crea la primera solicitud de crédito para empezar a operar.</p>
                <button class="btn-primary" routerLink="/applications/new">
                    <ion-icon name="add-outline"></ion-icon> Crear Solicitud
                </button>
            </div>
            } @else {
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Solicitante</th>
                        <th>País</th>
                        <th>Monto</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @for (app of applications(); track app.id) {
                    <tr class="table-row">
                        <td>#{{ app.id }}</td>
                        <td>
                            <div class="user-info">
                                <span class="user-name">{{ app.full_name }}</span>
                                <span class="user-doc">{{ app.identity_document }}</span>
                            </div>
                        </td>
                        <td><span class="badge badge-outline">{{ app.country_name || app.country }}</span></td>
                        <td class="amount">{{ formatCurrency(app.requested_amount) }}</td>
                        <td>{{ app.created_at | date:'shortDate' }}</td>
                        <td>
                            <span class="status-badge" [ngClass]="getStatusClass(app.status)">
                                {{ app.status_name || (app.status | uppercase) }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" title="Ver Detalles" [routerLink]="['/applications', app.id]">
                                    <ion-icon name="eye-outline"></ion-icon>
                                </button>
                            </div>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>

            <!-- Controles de Paginación -->
            <div class="pagination-controls shadow-premium">
                <div class="pagination-info">
                    Registros {{ (currentPage() - 1) * 20 + 1 }} - {{ (currentPage() * 20) > totalItems() ? totalItems()
                    : (currentPage() * 20) }} de <strong>{{ totalItems() }}</strong>
                </div>
                <div class="pagination-actions">
                    <button class="btn-page" [disabled]="currentPage() === 1" (click)="changePage(currentPage() - 1)">
                        <ion-icon name="chevron-back-outline"></ion-icon>
                    </button>

                    <span class="page-current">Página {{ currentPage() }} de {{ totalPages() }}</span>

                    <button class="btn-page" [disabled]="currentPage() === totalPages()"
                        (click)="changePage(currentPage() + 1)">
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </button>
                </div>
            </div>
            }
        </div>


    </main>
</div>